// scripts/config/openai-config.js
// Конфигурация OpenAI API для генерации женских версий архетипов

require('dotenv').config({ path: require('path').join(__dirname, '../../.env.local') });

const OPENAI_CONFIG = {
  apiKey: process.env.OPENAI_API_KEY || process.env.OPENAI_KEY,
  model: 'gpt-4-turbo-preview', // Используем GPT-4 для лучшего качества
  temperature: 0.7, // Баланс между креативностью и точностью
  maxTokens: 500,
  timeout: 30000,
  retries: 3,
  retryDelay: 2000
};

// Промпт-шаблоны для разных типов контента
const PROMPT_TEMPLATES = {
  forecast: `Ты - эксперт по китайской астрологии Бацзы, специализирующийся на женской энергетике.

Преобразуй этот прогноз для мужчины в аутентичную женскую версию.

ВАЖНО:
1. СОХРАНИ структуру и основной смысл
2. ИЗМЕНИ метафоры на женские (не "воин", а "хранительница"; не "дуб", а "ива")
3. ИЗМЕНИ фокус: вместо экспансии - гармония, вместо завоевания - привлечение
4. ИЗМЕНИ глаголы: вместо "прояви" → "укрепи проявление", вместо "расширяй" → "углубляй"
5. УЧТИ китайскую культуру: женская энергия (Yin) - это восприимчивость, внутренняя сила, цикличность

Элемент: {{element}}
Сила: {{strength}}

МУЖСКОЙ ПРОГНОЗ:
{{maleText}}

ЖЕНСКАЯ ВЕРСИЯ (должна быть естественной, не просто заменой слов):`,

  energy: `Ты - мудрая наставница по Бацзы, понимающая женскую энергию.

Опиши эту энергию с женской перспективы, сохранив смысл, но изменив форму.

АКЦЕНТ НА:
- Восприятие и интуицию, а не только действие
- Цикличность и ритмы, а не линейный рост
- Внутренние процессы и глубину, а не внешние достижения
- Гармонию и баланс, а не экспансию

Элемент: {{element}}
Сила: {{strength}}

МУЖСКОЕ ОПИСАНИЕ ЭНЕРГИИ:
{{maleText}}

ЖЕНСКОЕ ОПИСАНИЕ ЭНЕРГИИ:`,

  advice: `Ты - практикующий мастер Бацзы, дающий советы женщинам.

Перепиши этот совет для женщины, сделав его:
- Более практичным и конкретным
- Ориентированным на отношения и гармонию
- С акцентом на внутреннюю силу, а не внешнюю экспансию
- Учитывающим женские социальные роли в китайской культуре

Элемент: {{element}}
Сила: {{strength}}

МУЖСКОЙ СОВЕТ:
{{maleText}}

ЖЕНСКИЙ СОВЕТ:`,

  ritual: `Создай женскую версию этого ритуала Бацзы.

ИЗМЕНИ:
- Время выполнения (где уместно: утро → вечер, для женской энергии Инь)
- Элементы и материалы (более мягкие, природные, интуитивные)
- Инструкции (более плавные, циклические, не линейные)
- Цель (больше гармонии и внутреннего баланса, меньше борьбы и достижений)

Элемент: {{element}}
Сила: {{strength}}

МУЖСКОЙ РИТУАЛ:
{{maleText}}

ЖЕНСКИЙ РИТУАЛ:`,

  transformation: `Опиши это превращение для женщины.

СДЕЛАЙ АКЦЕНТ НА:
- Личностный рост и глубину, а не только социальный статус
- Внутреннюю трансформацию, а не внешние изменения
- Устойчивость и корни, а не скорость и высоту
- Связи и отношения, а не только индивидуальные достижения

Элемент: {{element}}
Сила: {{strength}}

МУЖСКОЕ ПРЕВРАЩЕНИЕ:
{{maleText}}

ЖЕНСКОЕ ПРЕВРАЩЕНИЕ:`
};

// Функция получения промпта
function getPrompt(contentType, maleText, element, strength) {
  const template = PROMPT_TEMPLATES[contentType];
  if (!template) {
    throw new Error(`Неизвестный тип контента: ${contentType}`);
  }
  
  return template
    .replace(/\{\{element\}\}/g, element)
    .replace(/\{\{strength\}\}/g, strength)
    .replace(/\{\{maleText\}\}/g, maleText);
}

// Базовая модификация как fallback (если API недоступен)
function applyBasicGenderModifiers(text, contentType) {
  if (!text) return text;
  
  const replacements = {
    // Глаголы действия
    'прояви': 'укрепи проявление',
    'активно': 'осознанно',
    'расширяй': 'углубляй',
    'завоюй': 'привлеки',
    'захвати': 'создай',
    'действуй': 'прочувствуй',
    'брось вызов': 'открой возможности',
    
    // Метафоры
    'воин': 'хранительница',
    'дуб': 'ива',
    'гора': 'долина',
    'меч': 'зеркало',
    'битва': 'путешествие',
    'победа': 'гармония',
    'завоевание': 'создание',
    
    // Фокусы
    'сила': 'внутренняя сила',
    'экспансия': 'углубление',
    'влияние': 'притяжение',
    'лидерство': 'гармония',
    
    // Время и ритмы
    'утром': 'вечером',
    'на рассвете': 'на закате',
    'быстро': 'постепенно',
    'сразу': 'в своем ритме'
  };
  
  let result = text;
  for (const [from, to] of Object.entries(replacements)) {
    const regex = new RegExp(from, 'gi');
    result = result.replace(regex, to);
  }
  
  // Добавляем женские акценты в зависимости от типа контента
  if (contentType === 'advice') {
    result = result.replace(/важно/g, 'важно для гармонии');
  }
  
  if (contentType === 'ritual') {
    result = result.replace(/делай/g, 'выполняй мягко');
  }
  
  return result;
}

module.exports = {
  OPENAI_CONFIG,
  PROMPT_TEMPLATES,
  getPrompt,
  applyBasicGenderModifiers
};

