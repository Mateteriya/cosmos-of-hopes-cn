// content-generator.js - СИСТЕМА ГЕНЕРАЦИИ КОНТЕНТА С ДВУМЯ СТИЛЯМИ
// Генерирует персонализированные прогнозы на языке возможностей
// Два стиля: поэтически-метафорический и разговорно-практический

// --- МАТРИЦА КОНТЕНТА: ПОЭТИЧЕСКИ-МЕТАФОРИЧЕСКИЙ СТИЛЬ ---
const poeticContentMatrix = {
  'Дерево': {
    weak: {
      forecast: "Год Укоренения. Ваше время — не для рывка ввысь, а для того, чтобы пустить глубокие и терпеливые корни в почву вашей жизни.",
      energy: "Тишиной и мудростью планирования. Сила может прийти через осознание, куда вы на самом деле хотите расти.",
      advice: "Направьте заботу на фундамент: здоровье, daily routine, круг самых близких. Может быть полезно отказаться от того, что истощает вашу почву.",
      ritual: "Заведите «Дневник роста»: раз в неделю записывайте одно маленькое, но устойчивое изменение к лучшему. Цените процесс, а не высоту."
    },
    medium: {
      forecast: "Год Прорастания. Энергии года, как солнце и дождь, могут питать ваши планы. Это время, чтобы смело сажать семена будущего и учиться доверять естественному ходу вещей.",
      energy: "Смелостью начинать и гибкостью следовать за светом. У вас могут найтись силы и ясность, чтобы пробиться к свету.",
      advice: "Сфокусируйтесь на одном главном начинании, дайте ему пространство. Вам могут помочь гибкие формы, а не жёсткие рамки.",
      ritual: "Создайте «Карту желаемого роста»: визуальный образ (коллаж, мудборд) того, как могло бы выглядеть ваше «дерево» к концу года."
    },
    strong: {
      forecast: "Год Цветения и Лидерства. Вы можете ощутить мощный подъём жизненной силы. Ваша энергия может стать подобна кроне зрелого дерева: дающей опору и требующей простора.",
      energy: "Уверенностью вести за собой и ответственностью за свой «лес». Ваша сила может проявиться через щедрость — способность давать «тень» и «плоды».",
      advice: "Направьте изобилие энергии на преодоление давней преграды или поддержку того, что выростило вас. Старайтесь избегать излишней прямолинейности («вырубки») на своём пути.",
      ritual: "Практикуйте «Энергетический обмен»: на каждое потраченное на дело усилие находите момент покоя у воды или с книгой, чтобы восстановить соки."
    }
  },
  'Огонь': {
    weak: {
      forecast: "Год Зажжённой Искры. Год может осторожно раздувать ваше внутреннее пламя. Ваша задача — бережно хранить то, что даёт вам тепло и интерес к жизни.",
      energy: "Поиском вдохновения в малом и благодарностью за моменты тихой радости. Ваш свет может быть ценен своей искренностью.",
      advice: "Ищите и создавайте уютные, тёплые ритуалы (утренний чай, разговор при свечах). Может помочь отказ от «сквозняков» суеты и токсичного общения.",
      ritual: "Создайте «Алтарь радости» — цифровой или реальный уголок с изображениями, цитатами, предметами, которые заставляют вас мягко улыбнуться."
    },
    medium: {
      forecast: "Год Яркого Пламени. Ваш внутренний свет может гореть ровно и притягательно. Это время для творчества, сердечного общения и деления теплом.",
      energy: "Легкостью бытия и щедростью души. Вы можете заметить, как к вам чаще приходят хорошие события, когда вы излучаете доброжелательность.",
      advice: "Делитесь своим теплом: хвалите, вдохновляйте, собирайте людей вокруг красоты и добрых дел. Вы можете стать солнцем в своём кругу.",
      ritual: "Устройте «Неделю искренних комплиментов»: каждый день находите повод отметить что-то прекрасное в близком человеке и говорите ему об этом."
    },
    strong: {
      forecast: "Год Солнечного Пика. Ваша энергия может быть на максимуме, вы можете оказаться в центре внимания. Год требует мудрого обращения с силой, чтобы не перегореть и не опалить других.",
      energy: "Силой влияния и страстью к свершениям. Вы можете вести за собой, но важно помнить о ресурсах — своих и чужих.",
      advice: "Направьте мощную энергию в созидательные, чётко очерченные проекты. Вам может помочь «заземление» в спокойных, надёжных людях (элемент Земля).",
      ritual: "Введите правило «Огненной паузы»: перед важным решением или эмоциональной реакцией сделайте 5 глубоких вдохов-выдохов, представляя, как пламя становится ровным и управляемым."
    }
  },
  'Земля': {
    weak: {
      forecast: "Год Плодородной Целины. Год может дать питательную энергию для укрепления основ. Ваше время — вспахивать, удобрять и засевать свою жизненную почву.",
      energy: "Накоплением ресурсов и заботой о фундаменте (здоровье, дом, режим). Каждый маленький ритуал заботы о себе может стать семенем будущей стабильности.",
      advice: "Сосредоточьтесь на построении и укреплении одного самого важного «участка» вашей жизни. Доверяйте проверенным источникам.",
      ritual: "Практика «Ежедневного камня»: каждый день кладите в прозрачную банку один камешек (или записывайте), символизирующий одно маленькое, но твёрдо выполненное дело."
    },
    medium: {
      forecast: "Год Гармоничного Сада. Вы можете стать центром притяжения и опорой. Это время пожинать плоды прошлых усилий, завершать дела и дарить близким чувство надёжного тыла.",
      energy: "Глубоким удовлетворением от порядка и способностью создавать уют и безопасность для других. Ваша сила может проявиться в предсказуемом постоянстве.",
      advice: "Используйте свою стабильность, чтобы завершить долгострой, привести в идеальный порядок важное пространство или стать «тихой гаванью» для кого-то.",
      ritual: "Проведите «Церемонию завершения»: торжественно закройте один старый, висящий «хвост» (физический или эмоциональный), поблагодарив его за урок."
    },
    strong: {
      forecast: "Год Незыблемой Горы. Вы можете чувствовать себя непоколебимо, но есть риск окаменеть. Год призывает использовать вашу силу для поддержки слабых и решения сложных, «каменистых» вопросов.",
      energy: "Терпением и невероятной выносливостью. Вы можете выдержать многое, но важно не давить своей массой, а быть опорой.",
      advice: "Направьте свою энергию на то, чтобы нести груз ответственности (семейной, социальной) или медленно, но верно двигать «гору» старой проблемы.",
      ritual: "Практика «Мягкого взгляда»: раз в день сознательно ищите красоту в чём-то хрупком, изменчивом, непостоянном (роса, облако, детский смех), чтобы развивать гибкость."
    }
  },
  'Металл': {
    weak: {
      forecast: "Год Заточки Инструмента. Ваша «сталь» сейчас может проходить закалку. Год учит ценить качество над количеством, ясность малых целей над масштабом.",
      energy: "Сосредоточением на главном и дисциплиной в малом. Ваша сила может расти от чётко очерченных обязательств перед самим собой.",
      advice: "Сфокусируйтесь на оттачивании одного навыка или выполнении одного, но безупречного обязательства. Может помочь отсечение всего, что распыляет фокус.",
      ritual: "Заведите «Журнал ясности»: каждый вечер записывайте один чёткий вывод или решение, принятое за день. Это ваш ежедневный «удар молота по металлу»."
    },
    medium: {
      forecast: "Год Чётких Граней. Ваш ум может стать яснее, решения — взвешенными. Это идеальное время для ревизии, расхламления и утверждения личных границ.",
      energy: "Чувством справедливости и способностью отделять ценное от пустого. Вам может открыться умение видеть суть сквозь шелуху.",
      advice: "Проведите аудит жизни: что служит вашим истинным ценностям, а что — лишь балласт? Вы можете найти в себе смелость отказаться от второго.",
      ritual: "Практика «Эмоционального минимализма»: сознательно откажитесь на неделю от жалоб, сплетен и бесплодных споров. Наблюдайте за ясностью, которая может прийти."
    },
    strong: {
      forecast: "Год Меча Мудрости. Вы можете ощутить остроту и силу своей воли. Год требует мудрого применения лезвия — для защиты слабых, разрезания узлов проблем, а не для нанесения ран.",
      energy: "Решительностью и силой духа. Вы можете оказаться способны на смелые поступки, но истинная сила — в контроле над остриём.",
      advice: "Направьте свою мощь на «рассечение» одной сложной, запутанной проблемы в вашей жизни. Старайтесь избегать резких суждений и цинизма.",
      ritual: "Практика «Округления краёв»: каждый день совершайте один маленький, неожиданно мягкий поступок (помощь, комплимент, прощение мелкой оплошности)."
    }
  },
  'Вода': {
    weak: {
      forecast: "Год Тихого Родника. Ваш источник может нуждаться в покое. Год зовёт к тишине, созерцанию и накоплению мудрости изнутри, а не из шумного внешнего мира.",
      energy: "Глубоким слушанием — себя, природы, мудрых мыслей. Ваша сила может раскрыться в способности впитывать и хранить, а не изливать.",
      advice: "Создайте вокруг себя защитный «берег» от информационного шума и эмоционально истощающих людей. Ищите знания, которые питают душу.",
      ritual: "Практика «Цифрового поста»: выделите один час в день, полностью отключив все гаджеты. Наблюдайте за течением своих мыслей, как за течением реки."
    },
    medium: {
      forecast: "Год Плавной Реки. Вы можете найти путь, обтекая препятствия. Это время для общения, учебы, путешествий и налаживания связей. Доверяйте своему течению.",
      energy: "Адаптивностью и коммуникабельностью. Вы сможете легко находить общий язык с разными людьми и ситуациями, сохраняя внутренний стержень.",
      advice: "Позвольте себе исследовать новое русло: тему, навык, круг общения. Делитесь своими «водами» — опытом и идеями — с теми, кто в них нуждается.",
      ritual: "Практика «Вопросов вместо ответов»: в беседах больше задавайте глубокие, открытые вопросы. Вы сможете стать проводником, который помогает другим найти их собственный поток."
    },
    strong: {
      forecast: "Год Глубокого Океана. Ваша энергия может ощущаться бездонной. Вы можете стать опорой и советчиком для многих. Год призывает к развитию внутренней глубины через анализ и сострадание.",
      energy: "Спокойной мощью и проницательностью. Вам может открыться видение скрытых течений и глубинных причин. Ваша задача — не поддаваться темным водоворотам эмоций.",
      advice: "Используйте свою глубину для помощи другим в навигации по их эмоциональным водам. Вы сможете стать тем, кто сохраняет спокойствие в шторм.",
      ritual: "Практика «Прилив и отлив»: сознательно чередуйте периоды активной социальной вовлечённости с периодами полного уединения для «осаждения» впечатлений."
    }
  }
};

// --- МАТРИЦА КОНТЕНТА: РАЗГОВОРНО-ПРАКТИЧЕСКИЙ СТИЛЬ ---
const practicalContentMatrix = {
  'Дерево': {
    weak: {
      forecast: "Год закладки основ. Не время для резких прыжков. Лучше сосредоточиться на том, чтобы создать прочную базу для будущего.",
      energy: "Ощущение, что нужно замедлиться и всё обдумать. Сила появится, когда станет понятно, что вы на самом деле хотите развивать.",
      advice: "Уделите внимание основам: здоровью, распорядку дня, самым близким людям. Откажитесь от того, что высасывает ваши силы без результата.",
      ritual: "Недельный чек-лист: раз в неделю записывайте один маленький, но полезный шаг, который вы сделали для своего будущего."
    },
    medium: {
      forecast: "Год удачных стартов. Энергия года поддерживает новые начинания. Можно смело браться за планы и позволить событиям развиваться естественно.",
      energy: "Чувствуется смелость начать и гибкость подстраиваться под обстоятельства. Есть ясность и силы двигаться к цели.",
      advice: "Выберите один ключевой проект и сосредоточьтесь на нём. Планируйте, но оставляйте пространство для манёвра.",
      ritual: "Доска визуализации: создайте (хоть в Pinterest) подборку образов, как должен выглядеть ваш успех в этом деле через год."
    },
    strong: {
      forecast: "Год прорыва и влияния. Ощущается большой прилив сил. Вы можете вести за собой, ваша энергия заметна окружающим.",
      energy: "Уверенность в себе и чувство ответственности. Сила — в том, чтобы помогать другим и делиться результатами.",
      advice: "Используйте этот подъём, чтобы наконец решить застарелую проблему или помочь тому, кто вас поддерживал. Избегайте конфликтов и грубого давления.",
      ritual: "Правило баланса: после каждого важного и энергозатратного дела находите время на полное спокойствие — просто посидеть в тишине или почитать."
    }
  },
  'Огонь': {
    weak: {
      forecast: "Год восстановления интереса. Энергия как будто разгорается медленно. Важно беречь то, что вас искренне радует и мотивирует.",
      energy: "Поиск вдохновения в простых вещах и благодарность за хорошие моменты. Ваша ценность — в искренности.",
      advice: "Создавайте себе маленькие ежедневные удовольствия (любимый напиток, спокойный разговор). Избегайте суеты и людей, после которых чувствуете себя опустошённым.",
      ritual: "Коллекция хорошего: заведите папку (в телефоне или реальную), куда будете собирать то, что поднимает настроение: фото, цитаты, открытки."
    },
    medium: {
      forecast: "Год гармонии и тепла. Чувствуете себя в ресурсе, готовы творить и общаться. Ваше хорошее настроение притягивает позитивные события.",
      energy: "Лёгкость и желание делиться хорошим. Вы привлекаете людей своей открытостью и доброжелательностью.",
      advice: "Чаще хвалите, поддерживайте, собирайте друзей за приятными делами. Станьте тем, кто создаёт вокруг себя тёплую атмосферу.",
      ritual: "Челлендж доброты: неделю каждый день делайте один конкретный комплимент или маленькое доброе дело для другого человека."
    },
    strong: {
      forecast: "Год высокой активности. Много сил, можете оказаться на виду у всех. Важно управлять этой энергией, чтобы не выгореть и не испортить отношения.",
      energy: "Ощущение влияния и амбициозность. Вы можете быть лидером, но важно не забывать отдыхать и учитывать чувства других.",
      advice: "Вложите энергию в один большой и ясный проект. Найдите точку опоры в спокойных и надёжных людях.",
      ritual: "Пятиминутная пауза: перед тем как принять решение на эмоциях, остановитесь и 5 раз глубоко вдохните-выдохните, чтобы «остыть»."
    }
  },
  'Земля': {
    weak: {
      forecast: "Год укрепления позиций. Время работать над фундаментом: здоровьем, бытом, финансами. Каждое маленькое дело копится в будущую уверенность.",
      energy: "Фокус на накоплении ресурсов и заботе о себе. Каждый шаг к порядку даёт чувство защищённости.",
      advice: "Выберите одну ключевую сферу жизни (например, дом или здоровье) и последовательно приведите её в порядок. Доверяйте только проверенным методам.",
      ritual: "Банка достижений: каждый день кладите в банку монетку или записывайте одно маленькое, но полезное дело, которое вы завершили."
    },
    medium: {
      forecast: "Год порядка и надёжности. Вы чувствуете себя устойчиво и можете быть опорой для других. Можно завершать старые дела и наслаждаться результатами.",
      energy: "Удовлетворение от наведённого порядка и способность создавать для близких ощущение безопасности и комфорта.",
      advice: "Используйте эту стабильность, чтобы разобрать «долгострой», навести идеальный порядок в шкафу или просто быть рядом с тем, кому нужна поддержка.",
      ritual: "Ритуал закрытия: символически завершите одно давно висящее дело (выбросьте хлам, отправьте давно написанное письмо, простите мелкую обиду)."
    },
    strong: {
      forecast: "Год ответственности. Вы чувствуете себя очень устойчиво, но можете стать слишком непреклонным. Сила — в том, чтобы помогать другим и решать сложные вопросы.",
      energy: "Большое терпение и выносливость. Вы многое можете выдержать, но важно не давить авторитетом, а поддерживать.",
      advice: "Возьмите на себя ответственность в семье или проекте. Или медленно, шаг за шагом, решите одну хроническую проблему.",
      ritual: "Упражнение на гибкость: раз в день намеренно обращайте внимание на что-то мимолётное и красивое (например, небо), напоминая себе, что не всё должно быть под контролем."
    }
  },
  'Металл': {
    weak: {
      forecast: "Год фокусировки. Время работать не над количеством, а над качеством. Чёткие маленькие цели сейчас важнее масштабных, но размытых планов.",
      energy: "Внутренняя концентрация и дисциплина. Сила растёт, когда вы доводите до конца даже маленькие обязательства перед самим собой.",
      advice: "Выберите один навык для прокачки или одно небольшое, но важное обещание себе и выполните его безупречно. Откажитесь от всего, что отвлекает.",
      ritual: "Дневник решений: каждый вечер записывайте один чёткий и конкретный вывод, который вы сделали за день."
    },
    medium: {
      forecast: "Год наведения порядка. Ум ясный, легко отделять важное от второстепенного. Идеальное время для расхламления — как в делах, так и в отношениях.",
      energy: "Обострённое чувство справедливости и умение видеть суть вещей. Вы понимаете, что для вас ценно, а что — нет.",
      advice: "Проведите ревизию: в работе, общении, привычках. Смело отказывайтесь от того, что тянет вас назад или не соответствует вашим принципам.",
      ritual: "Неделя чистоты речи: попробуйте неделю не жаловаться, не сплетничать и не вступать в бесполезные споры. Посмотрите, как изменится ваше состояние."
    },
    strong: {
      forecast: "Год решительных действий. Чувствуется внутренняя твёрдость и сила воли. Важно применять её с умом — для защиты, решения проблем, а не для конфликтов.",
      energy: "Решительность и внутренний стержень. Вы способны на смелые шаги, но главное — сохранять контроль и не быть резким.",
      advice: "Сфокусируйте эту мощь на решении одной самой запутанной и сложной задачи. Избегайте категоричных суждений и чёрно-белого мышления.",
      ritual: "Тренировка мягкости: каждый день делайте один необязательный, но добрый жест (уступите место, помогите донести тяжёлое, сделайте комплимент)."
    }
  },
  'Вода': {
    weak: {
      forecast: "Год восстановления ресурсов. Время замедлиться, меньше общаться и больше прислушиваться к себе. Сила — в умении отдыхать и накапливать знания.",
      energy: "Потребность в тишине и глубоком понимании. Вы заряжаетесь, когда слушаете, читаете, размышляете, а не когда активно действуете.",
      advice: "Сократите поток ненужной информации и общение с теми, кто вас утомляет. Ищите знания, которые вас вдохновляют и успокаивают.",
      ritual: "Цифровой детокс: выделяйте один час в день без телефона и ноутбука. Просто побудьте наедине с собой или с природой."
    },
    medium: {
      forecast: "Год общения и движения. Легко находите общий язык с другими и подстраиваетесь под обстоятельства. Хорошее время для учебы, поездок и новых знакомств.",
      energy: "Гибкость и коммуникабельность. Вы сохраняете своё мнение, но при этом можете договориться с кем угодно.",
      advice: "Попробуйте что-то новое: курс, хобби, смените обстановку. Делитесь своим опытом с теми, кому это может быть полезно.",
      ritual: "Игра в вопросы: в разговорах попробуйте больше задавать открытые вопросы и действительно слушать ответы, вместо того чтобы говорить о себе."
    },
    strong: {
      forecast: "Год проницательности. Вы хорошо чувствуете скрытые мотивы и можете быть мудрым советчиком. Важно не погружаться слишком глубоко в чужие проблемы.",
      energy: "Спокойная сила и умение видеть корень ситуации. Вы можете помочь другим разобраться в их чувствах, сохраняя собственное спокойствие.",
      advice: "Используйте свою способность понимать, чтобы помогать близким советом или просто спокойным присутствием. Избегайте эмоциональных перегрузок.",
      ritual: "Режим включения/выключения: сознательно чередуйте активные социальные дни с днями полного уединения, чтобы «переварить» впечатления."
    }
  }
};

// --- АМУЛЕТЫ И ПРЕДОСТЕРЕЖЕНИЯ (ОБЩИЕ ДЛЯ ОБОИХ СТИЛЕЙ) ---
const amuletAndTaboos = {
  'Дерево': {
    amulet: "Браслет из зелёной яшмы (玉) или деревянная подвеска в форме ростка",
    action: "Окружите себя живыми растениями, начните вести дневник роста и развития",
    taboos: {
      months: "Избегайте спешки и конфронтаций в месяцы Металла (申酉, август-октябрь)",
      health: "Следите за здоровьем печени и глаз, практикуйте регулярный отдых от экранов"
    }
  },
  'Огонь': {
    amulet: "Украшение с красным агатом или качественные солнцезащитные очки в красной оправе",
    action: "Создайте пространство для творчества, делитесь вдохновляющим опытом с близким кругом",
    taboos: {
      months: "Будьте осмотрительны в важных партнёрствах и крупных обязательствах",
      health: "Контролируйте давление и избегайте избытка острой и горячей пищи"
    }
  },
  'Земля': {
    amulet: "Керамический или фарфоровый кулон, кристалл пирита",
    action: "Систематизируйте важные области жизни, устроите капитальную организацию пространства",
    taboos: {
      months: "Остерегайтесь рискованных материальных обязательств. Особенно в месяцы Дерева (寅卯, февраль-апрель)",
      health: "Уделяйте внимание желудку и селезёнке, соблюдайте режим питания"
    }
  },
  'Металл': {
    amulet: "Брелок в форме монеты (古钱) из металла, минималистичные стальные часы",
    action: "Проведите ревизию важных навыков, освободите пространство от лишнего (физического и ментального)",
    taboos: {
      months: "Избегайте участия в конфликтных ситуациях и острых публичных дискуссиях",
      health: "Берегите лёгкие и кожу, практикуйте дыхательные упражнения"
    }
  },
  'Вода': {
    amulet: "Чёрный/синий браслет из гематита, символ потока и мудрости",
    action: "Начните вести дневник инсайтов и наблюдений, практикуйте медитацию и внутреннюю тишину",
    taboos: {
      months: "Осторожность в поездках и перемещениях в месяцы Земли (辰戌丑未)",
      health: "Контролируйте эмоциональные перепады и берегите почки, поддерживайте водный баланс"
    }
  }
};

// --- ПРИМЕНЕНИЕ МОДИФИКАТОРОВ ОТ ВЗАИМОДЕЙСТВИЙ ---
function applyInteractionModifiers(interactions, stemInteractions = [], specialCombinations = []) {
  const modifiers = {
    forecastAddition: '',
    notes: []
  };
  
  const hasMerger = interactions.some(i => i.type === '合' && i.impact === 'positive');
  if (hasMerger) {
    modifiers.forecastAddition += 'В этом году вы можете рассчитывать на неожиданную поддержку и гармоничные союзы, которые могут прийти словно сами собой.';
    modifiers.notes.push('Наличие слияний в вашей карте указывает на благоприятные союзы и взаимную поддержку.');
  }
  
  const hasClash = interactions.some(i => i.type === '冲');
  if (hasClash) {
    modifiers.forecastAddition += ' Год может принести важные перемены; сохраняйте внутреннее равновесие, чтобы суметь использовать их себе во благо.';
    modifiers.notes.push('Столкновения в карте указывают на период перемен, требующий гибкости и адаптивности.');
  }
  
  const hasPunishment = interactions.some(i => i.type === '刑' && i.impact === 'negative');
  if (hasPunishment) {
    modifiers.forecastAddition += ' Проявите терпение в сложных ситуациях; иногда мудрость — это дать времени всё расставить по местам.';
    modifiers.notes.push('Наличие наказаний требует особой внимательности к скрытым препятствиям.');
  }
  
  // НОВОЕ: Проверяем взаимодействия стволов (合化) - трансформация элементов
  if (stemInteractions && stemInteractions.length > 0) {
    const transformElements = stemInteractions.map(si => si.transformsTo);
    const uniqueElements = [...new Set(transformElements)];
    modifiers.forecastAddition += ` Ваша карта содержит взаимодействия стволов, которые могут трансформировать энергию в элементы ${uniqueElements.join(' и ')}. Это может усилить соответствующие качества в вашей жизни.`;
    modifiers.notes.push(`Взаимодействия стволов (合化) указывают на возможность трансформации энергии в элементы: ${uniqueElements.join(', ')}.`);
  }
  
  // НОВОЕ: Проверяем специальные комбинации (三合, 三会) - мощные триады
  const completeTriads = specialCombinations.filter(sc => sc.completeness === 'complete');
  if (completeTriads.length > 0) {
    const triadElements = completeTriads.map(t => t.element);
    modifiers.forecastAddition += ` В вашей карте присутствуют полные триады (${completeTriads.map(t => t.type).join(', ')}), что может создать мощную концентрацию энергии элементов ${[...new Set(triadElements)].join(' и ')}.`;
    modifiers.notes.push(`Полные триады (${completeTriads.map(t => t.name).join(', ')}) указывают на особую силу и концентрацию энергии.`);
  } else {
    const partialTriads = specialCombinations.filter(sc => sc.completeness === 'partial');
    if (partialTriads.length > 0) {
      modifiers.notes.push(`Частичные триады (${partialTriads.map(t => t.name).join(', ')}) указывают на потенциал для развития соответствующих качеств.`);
    }
  }
  
  return modifiers;
}

// --- ГЕНЕРАЦИЯ СОВЕТОВ ПО ВЗАИМОДЕЙСТВИЯМ ---
function generateInteractionAdvice(interactions) {
  const advice = {
    positive: [],
    neutral: [],
    warnings: []
  };
  
  interactions.forEach(interaction => {
    const pillarNames = {
      '年柱': 'семейных отношениях и корнях',
      '月柱': 'карьере и социальном статусе',
      '日柱': 'личной жизни и здоровье',
      '时柱': 'творчестве и потомках'
    };
    
    const pillarDesc = interaction.pillars.map(p => pillarNames[p] || p).join(' и ');
    
    if (interaction.impact === 'positive') {
      advice.positive.push({
        type: interaction.type,
        description: `${interaction.description} Особенно влияет на ${pillarDesc}.`
      });
    } else if (interaction.impact === 'neutral') {
      advice.neutral.push({
        type: interaction.type,
        description: `${interaction.description} Влияет на ${pillarDesc}.`
      });
    } else {
      advice.warnings.push({
        type: interaction.type,
        description: `${interaction.description} Будьте осторожны в ${pillarDesc}.`
      });
    }
  });
  
  return advice;
}

// --- ГЕНЕРАЦИЯ СОВЕТОВ ПО СИЛЕ СТВОЛОВ ---
function generateStemAdvice(stemStrengths) {
  const advice = [];
  const pillarNames = {
    year: 'Год',
    month: 'Месяц',
    day: 'День',
    hour: 'Час'
  };
  
  Object.entries(stemStrengths).forEach(([pillar, strength]) => {
    if (strength.strength <= 2) {
      advice.push({
        pillar: pillarNames[pillar],
        element: strength.element,
        glyph: strength.glyph,
        advice: `Ствол ${pillarNames[pillar]} (${strength.glyph}, ${strength.element}) слабый. Усильте его влияние через соответствующие элементы в окружении.`
      });
    } else if (strength.strength >= 4) {
      advice.push({
        pillar: pillarNames[pillar],
        element: strength.element,
        glyph: strength.glyph,
        advice: `Ствол ${pillarNames[pillar]} (${strength.glyph}, ${strength.element}) сильный. Используйте его энергию для достижения целей в соответствующей сфере.`
      });
    }
  });
  
  return advice;
}

// --- ГЛАВНАЯ ФУНКЦИЯ ГЕНЕРАЦИИ КОНТЕНТА ---
export function generateContent(baziAnalysis, currentYear = 2026, yearAnimal = 'Огненная Лошадь', style = 'poetic') {
  const dayMasterElement = baziAnalysis.dayMaster.element;
  const strength = baziAnalysis.dayMaster.strength;
  
  // Выбираем матрицу в зависимости от стиля
  const contentMatrix = style === 'poetic' ? poeticContentMatrix : practicalContentMatrix;
  const template = contentMatrix[dayMasterElement] || contentMatrix['Дерево'];
  
  // Определяем силу для выбора контента
  let strengthKey = 'medium';
  if (strength >= 4) strengthKey = 'strong';
  else if (strength <= 2) strengthKey = 'weak';
  
  // Получаем базовый контент
  const baseContent = template[strengthKey];
  
  // Применяем модификаторы от взаимодействий
  const interactionModifiers = applyInteractionModifiers(
    baziAnalysis.interactions || [],
    baziAnalysis.stemInteractions || [],
    baziAnalysis.specialCombinations || []
  );
  let forecast = baseContent.forecast;
  if (interactionModifiers.forecastAddition) {
    forecast += ' ' + interactionModifiers.forecastAddition;
  }
  
  // Генерируем дополнительные советы
  const interactionAdvice = generateInteractionAdvice(baziAnalysis.interactions || []);
  const stemAdvice = generateStemAdvice(baziAnalysis.stemStrengths || {});
  
  // Получаем амулеты и предостережения
  const amuletData = amuletAndTaboos[dayMasterElement] || amuletAndTaboos['Дерево'];
  
  // Формируем результат
  return {
    style: style, // Сохраняем выбранный стиль
    forecast: {
      main: forecast,
      year: `${currentYear} год (${yearAnimal})`,
      element: dayMasterElement,
      strength: strength
    },
    energy: {
      description: baseContent.energy
    },
    advice: {
      direction: baseContent.advice
    },
    ritual: {
      description: baseContent.ritual
    },
    amulet: {
      item: amuletData.amulet,
      action: amuletData.action,
      colors: baziAnalysis.usefulElements.map(el => {
        const colorMap = {
          'Дерево': 'зелёный',
          'Огонь': 'красный',
          'Земля': 'жёлтый/коричневый',
          'Металл': 'белый/золотой',
          'Вода': 'синий/чёрный'
        };
        return colorMap[el] || el;
      })
    },
    taboos: {
      months: amuletData.taboos.months,
      health: amuletData.taboos.health,
      additional: interactionAdvice.warnings
    },
    additional: {
      interactions: interactionAdvice,
      stemStrengths: stemAdvice,
      usefulElements: baziAnalysis.usefulElements,
      interactionNotes: interactionModifiers.notes
    }
  };
}

// --- ФОРМАТИРОВАНИЕ ДЛЯ ВЫВОДА ---
export function formatContentForDisplay(content) {
  return {
    style: content.style,
    mainForecast: `${content.forecast.year}: ${content.forecast.main}`,
    energy: content.energy.description,
    advice: content.advice.direction,
    ritual: content.ritual.description,
    recommendations: {
      amulet: `Амулет: ${content.amulet.item}`,
      action: `Действие: ${content.amulet.action}`,
      colors: `Благоприятные цвета: ${content.amulet.colors.join(', ')}`
    },
    warnings: {
      months: content.taboos.months,
      health: content.taboos.health,
      additional: content.taboos.additional
    },
    interactions: {
      positive: content.additional.interactions.positive,
      neutral: content.additional.interactions.neutral,
      warnings: content.additional.interactions.warnings
    },
    stemAdvice: content.additional.stemStrengths,
    interactionNotes: content.additional.interactionNotes
  };
}
